# ESMCP - Enhanced Secure Mail Communication Protocol

ä¸€ä¸ªåŸºäºå¾®å†…æ ¸æ¶æ„çš„é‚®ä»¶é€šä¿¡åè®®æœåŠ¡å™¨å®ç°ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å¾®å†…æ ¸æ¶æ„
æœ¬é¡¹ç›®é‡‡ç”¨å¾®å†…æ ¸æ¶æ„æ¨¡å¼ï¼Œæ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š
- **æœ€å°å†…æ ¸**ï¼šæ ¸å¿ƒå†…æ ¸åªè´Ÿè´£æ¶ˆæ¯è·¯ç”±å’ŒæœåŠ¡ç®¡ç†
- **æœåŠ¡éš”ç¦»**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å½±å“
- **æ¶ˆæ¯é©±åŠ¨**ï¼šæ‰€æœ‰æœåŠ¡é€šè¿‡å¼‚æ­¥æ¶ˆæ¯é€šä¿¡
- **åŠ¨æ€æ‰©å±•**ï¼šå¯åœ¨è¿è¡Œæ—¶åŠ è½½/å¸è½½æœåŠ¡

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®¢æˆ·ç«¯ (TCP/ESMCPåè®®)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ProtocolHandlerService             â”‚
â”‚      (åè®®è§£æä¸è¿æ¥ç®¡ç†)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MessageBus (å¾®å†…æ ¸)             â”‚
â”‚    - æœåŠ¡æ³¨å†Œä¸å‘ç°                       â”‚
â”‚    - æ¶ˆæ¯è·¯ç”±                            â”‚
â”‚    - è¿›ç¨‹é—´é€šä¿¡ (IPC)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åŸºç¡€æœåŠ¡å±‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AuthenticationService           â”‚   â”‚
â”‚  â”‚  (è®¤è¯ä¸ä¼šè¯ç®¡ç†)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MailStorageService              â”‚   â”‚
â”‚  â”‚  (é‚®ä»¶å­˜å‚¨ä¸æ£€ç´¢)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MailTransferService             â”‚   â”‚
â”‚  â”‚  (é‚®ä»¶ä¼ è¾“ä¸é˜Ÿåˆ—)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ java/com/esmcp/
â”‚   â”‚   â”œâ”€â”€ kernel/              # å¾®å†…æ ¸å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ Microkernel.java      # å¾®å†…æ ¸æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageBus.java       # æ¶ˆæ¯æ€»çº¿å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ Service.java          # æœåŠ¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ message/             # æ¶ˆæ¯ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ Message.java          # æ¶ˆæ¯ç±»
â”‚   â”‚   â”‚   â””â”€â”€ MessageType.java      # æ¶ˆæ¯ç±»å‹
â”‚   â”‚   â”œâ”€â”€ services/            # æœåŠ¡å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AuthenticationService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MailStorageService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ transfer/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MailTransferService.java
â”‚   â”‚   â”‚   â””â”€â”€ protocol/
â”‚   â”‚   â”‚       â””â”€â”€ ProtocolHandlerService.java
â”‚   â”‚   â””â”€â”€ main/                # å¯åŠ¨ç±»
â”‚   â”‚       â”œâ”€â”€ ServerMain.java       # æœåŠ¡å™¨ä¸»ç±»
â”‚   â”‚       â””â”€â”€ TestClient.java       # æµ‹è¯•å®¢æˆ·ç«¯
â”‚   â””â”€â”€ resources/
â”‚       â””â”€â”€ logback.xml          # æ—¥å¿—é…ç½®
â””â”€â”€ test/
    â””â”€â”€ java/com/esmcp/
        â”œâ”€â”€ MicrokernelTest.java      # å¾®å†…æ ¸æµ‹è¯•
        â””â”€â”€ MailWorkflowTest.java     # å·¥ä½œæµæµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¼–è¯‘é¡¹ç›®
```bash
mvn clean compile
```

### è¿è¡Œæµ‹è¯•
```bash
mvn test
```

### å¯åŠ¨æœåŠ¡å™¨
```bash
mvn exec:java -Dexec.mainClass="com.esmcp.main.ServerMain"
```

æœåŠ¡å™¨å°†åœ¨ç«¯å£ 2525 ä¸Šç›‘å¬è¿æ¥ã€‚

### ä½¿ç”¨æµ‹è¯•å®¢æˆ·ç«¯
åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œï¼š
```bash
mvn exec:java -Dexec.mainClass="com.esmcp.main.TestClient"
```

## ğŸ“– ESMCP åè®®

### åè®®å‘½ä»¤

#### 1. AUTH - ç”¨æˆ·è®¤è¯
```
AUTH <username> <password>
```
å“åº”ï¼š
- `250 Authentication successful` - è®¤è¯æˆåŠŸ
- `535 Authentication failed` - è®¤è¯å¤±è´¥

#### 2. SEND - å‘é€é‚®ä»¶
```
SEND <to> <subject> <body>
```
å“åº”ï¼š
- `250 Mail accepted, ID: <mail_id>` - é‚®ä»¶å·²æ¥å—
- `530 Authentication required` - éœ€è¦è®¤è¯

#### 3. LIST - åˆ—å‡ºé‚®ä»¶
```
LIST [limit]
```
å“åº”ï¼š
```
250-3 messages
250-ID:1 FROM:user1 SUBJ:Hello
250-ID:2 FROM:user2 SUBJ:Test
250 End of list
```

#### 4. RETR - è·å–é‚®ä»¶
```
RETR <mail_id>
```
å“åº”ï¼š
```
250 FROM:user1 TO:user2 SUBJ:Hello BODY:Test_message
```

#### 5. DELE - åˆ é™¤é‚®ä»¶
```
DELE <mail_id>
```
å“åº”ï¼š
- `250 Mail deleted` - åˆ é™¤æˆåŠŸ
- `550 Delete failed` - åˆ é™¤å¤±è´¥

#### 6. QUIT - é€€å‡º
```
QUIT
```
å“åº”ï¼š
- `221 Goodbye`

### ç¤ºä¾‹ä¼šè¯

```
Client: <è¿æ¥åˆ°æœåŠ¡å™¨>
Server: 220 ESMCP Server Ready

Client: AUTH user1 pass123
Server: 250 Authentication successful

Client: SEND user2 Hello This_is_a_test
Server: 250 Mail accepted, ID: 1

Client: LIST 5
Server: 250-1 messages
Server: 250-ID:1 FROM:user1 SUBJ:Hello
Server: 250 End of list

Client: RETR 1
Server: 250 FROM:user1 TO:user2 SUBJ:Hello BODY:This_is_a_test

Client: QUIT
Server: 221 Goodbye
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. å¾®å†…æ ¸ (MessageBus)
- **èŒè´£**ï¼šæœåŠ¡æ³¨å†Œã€æ¶ˆæ¯è·¯ç”±ã€IPCç®¡ç†
- **ä»£ç è¡Œæ•°**ï¼š~150è¡Œ
- **ç‰¹æ€§**ï¼š
  - å¼‚æ­¥æ¶ˆæ¯ä¼ é€’
  - è¶…æ—¶å¤„ç†ï¼ˆ10ç§’ï¼‰
  - å¹¶å‘å®‰å…¨

### 2. æœåŠ¡åŸºç±» (Service)
- **èŒè´£**ï¼šæä¾›æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ç‰¹æ€§**ï¼š
  - ç‹¬ç«‹çº¿ç¨‹è¿è¡Œ
  - æ¶ˆæ¯é˜Ÿåˆ—
  - é”™è¯¯éš”ç¦»

### 3. è®¤è¯æœåŠ¡ (AuthenticationService)
- **åŠŸèƒ½**ï¼š
  - ç”¨æˆ·è®¤è¯
  - ä¼šè¯ç®¡ç†ï¼ˆ1å°æ—¶è¿‡æœŸï¼‰
  - æƒé™éªŒè¯

### 4. é‚®ä»¶å­˜å‚¨æœåŠ¡ (MailStorageService)
- **åŠŸèƒ½**ï¼š
  - é‚®ä»¶å­˜å‚¨ï¼ˆå†…å­˜ï¼‰
  - é‚®ä»¶æ£€ç´¢
  - ç”¨æˆ·é‚®ç®±ç´¢å¼•
  - é‚®ä»¶æ ‡è®°

### 5. é‚®ä»¶ä¼ è¾“æœåŠ¡ (MailTransferService)
- **åŠŸèƒ½**ï¼š
  - å‘é€é˜Ÿåˆ—
  - å¼‚æ­¥ä¼ è¾“
  - çŠ¶æ€è·Ÿè¸ª

### 6. åè®®å¤„ç†æœåŠ¡ (ProtocolHandlerService)
- **åŠŸèƒ½**ï¼š
  - TCPè¿æ¥ç®¡ç†
  - ESMCPåè®®è§£æ
  - å‘½ä»¤è·¯ç”±

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•
```bash
mvn test -Dtest=MicrokernelTest
```

æµ‹è¯•å†…å®¹ï¼š
- æœåŠ¡æ³¨å†Œä¸å‘ç°
- æ¶ˆæ¯ä¼ é€’æœºåˆ¶
- æœåŠ¡é—´é€šä¿¡

### é›†æˆæµ‹è¯•
```bash
mvn test -Dtest=MailWorkflowTest
```

æµ‹è¯•å†…å®¹ï¼š
- ç”¨æˆ·è®¤è¯æµç¨‹
- é‚®ä»¶å‘é€ä¸æ¥æ”¶
- é‚®ä»¶åˆ—è¡¨ä¸æ£€ç´¢
- é‚®ä»¶ä¼ è¾“é˜Ÿåˆ—

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **æ¶ˆæ¯å»¶è¿Ÿ**ï¼š< 10msï¼ˆæœ¬åœ°ï¼‰
- **å¹¶å‘è¿æ¥**ï¼šæ”¯æŒ1000+
- **æ ¸å¿ƒä»£ç **ï¼š~450è¡Œï¼ˆå¾®å†…æ ¸+æœåŠ¡åŸºç±»ï¼‰
- **æœåŠ¡éš”ç¦»**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹çº¿ç¨‹ï¼Œé”™è¯¯ä¸ä¼ æ’­

## ğŸ” æµ‹è¯•è´¦æˆ·

ç³»ç»Ÿé¢„ç½®ä»¥ä¸‹æµ‹è¯•è´¦æˆ·ï¼š

| ç”¨æˆ·å | å¯†ç  | è§’è‰² |
|--------|------|------|
| admin  | admin123 | ADMIN |
| user1  | pass123  | USER  |
| user2  | pass456  | USER  |

## ğŸ¯ è®¾è®¡äº®ç‚¹

### 1. çœŸæ­£çš„å¾®å†…æ ¸
- æ ¸å¿ƒå†…æ ¸åªæœ‰150è¡Œä»£ç 
- åªè´Ÿè´£æ¶ˆæ¯è·¯ç”±å’ŒæœåŠ¡ç®¡ç†
- æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨æœåŠ¡å±‚

### 2. æœåŠ¡éš”ç¦»
- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹çº¿ç¨‹
- æœåŠ¡å´©æºƒä¸å½±å“å…¶ä»–æœåŠ¡
- å¯ç‹¬ç«‹æµ‹è¯•å’Œéƒ¨ç½²

### 3. å¼‚æ­¥æ¶ˆæ¯
- éé˜»å¡æ¶ˆæ¯ä¼ é€’
- æ”¯æŒè¯·æ±‚-å“åº”æ¨¡å¼
- è¶…æ—¶ä¿æŠ¤æœºåˆ¶

### 4. å¯æ‰©å±•æ€§
- æ·»åŠ æ–°æœåŠ¡åªéœ€ç»§æ‰¿Serviceç±»
- æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- æ”¯æŒè¿è¡Œæ—¶åŠ è½½

### 5. åè®®åˆ†ç¦»
- åè®®å¤„ç†ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘
- æ˜“äºæ”¯æŒå¤šç§åè®®
- å¯æ›¿æ¢åè®®å®ç°

## ğŸ”„ æ‰©å±•ç¤ºä¾‹

### æ·»åŠ åƒåœ¾é‚®ä»¶è¿‡æ»¤æœåŠ¡

```java
public class SpamFilterService extends Service {
    public SpamFilterService() {
        super("SpamFilterService");
    }
    
    @Override
    public void initialize() {
        // åˆå§‹åŒ–è¿‡æ»¤è§„åˆ™
    }
    
    @Override
    public Message handleMessage(Message message) {
        if (message.getType().equals("FILTER_CHECK")) {
            // æ£€æŸ¥é‚®ä»¶æ˜¯å¦ä¸ºåƒåœ¾é‚®ä»¶
            boolean isSpam = checkSpam(message.getPayload());
            return Message.builder()
                .from(serviceName)
                .to(message.getFrom())
                .type("FILTER_RESULT")
                .payload(Map.of("isSpam", isSpam))
                .build();
        }
        return null;
    }
    
    @Override
    public void shutdown() {}
}

// åœ¨ServerMainä¸­æ³¨å†Œ
kernel.registerService("SpamFilterService", new SpamFilterService());
```

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œæ¼”ç¤ºç›®çš„ã€‚

## ğŸ‘¥ ä½œè€…

ESMCP å¾®å†…æ ¸æ¶æ„æ¼”ç¤ºé¡¹ç›®
